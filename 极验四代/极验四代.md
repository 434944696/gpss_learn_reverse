# 极验四代滑块

> 网站地址： aHR0cHM6Ly9ndDQuZ2VldGVzdC5jb20v
>
> https://github.com/Guapisansan/gpss_learn_reverse 代码在这里，会持续更新逆向案例

**免责声明： 此文档，以及脚本，仅用来对技术的学习与探讨，如有冒犯，请联系作者电话，微信13933566015进行删除**

![image-20230829104436870](./极验四代.assets/image-20230829104436870.png)

上周做了一个云片滑块，

这周上一些强度，来个极验的

极验在业内还是有很大的知名度的。

冲冲冲！！！！！！！！！！！！！！！

## 流程分析

### 获取图片流程

点击刷新图片，然后滑动一下

![image-20230829105359798](./极验四代.assets/image-20230829105359798.png)

这里看着还是两个接口

第一个接口为，刷新图片的接口

第二个接口为，拉动验证码接口

咱们一个接口一个接口分析。

先看获取图片的



![image-20230829105658542](./极验四代.assets/image-20230829105658542.png)

这个接口参数有不少，

**callback**

**captcha_id**

**client_type**

**lot_number**

**risk_type**

**pt**

**lang**

**payload**

**process_token**

**payload_protocol**

再看一下响应信息

![image-20230829110139581](./极验四代.assets/image-20230829110139581.png)



里面包含，bg图片（背景图），slice图片(滑块图)

还是重放攻击，去除不必要参数。

![image-20230829111146008](./极验四代.assets/image-20230829111146008.png)

这里测试，只要一个captcha_id就可以拿到图片。


可以看一下这个captcha_id的来源和变化

我测了3次接口都是不变的

~~~
54088bb07d2df3c46b79f80300b0abbe
~~~

![image-20230829111412085](./极验四代.assets/image-20230829111412085.png)

发现写死的，所以我们也写死即可。

get图片的方式没有难度，先这样，如果有问题再回来看吧



### 验证图片流程

来看这个验证接口

![image-20230829111950861](./极验四代.assets/image-20230829111950861.png)

这里的参数和获取图片的一样， 

多了一个w，这个w肯定是关键，比如滑块轨迹之类的。

还是测试接口，

去除不必要参数

![image-20230829112437629](./极验四代.assets/image-20230829112437629.png)

这里必要参数是这三个

接口才会通，

**这里说的必要参数，是能把接口打通，起码会出现结果而非异常。**

**并不代表真正意义上的正确**

这个lot_number看一出处

![image-20230829112813870](./极验四代.assets/image-20230829112813870.png)

![image-20230829112839658](./极验四代.assets/image-20230829112839658.png)

这里发现验证接口的lot_number入参，在获取图片接口的出参里面有出现。

而验证接口的lot_number则是必要参数，而获取图片的不是必要参数。

所以重点还是放在w上。

## 逆向w

先找到w值的生成位置吧，

![image-20230829144019298](./极验四代.assets/image-20230829144019298.png)

找到verify验证的接口，然后从后往前跟

我们拉动滑块下一个断点

![image-20230829151130722](./极验四代.assets/image-20230829151130722.png)

到这个位置查看变量

![image-20230829151251014](./极验四代.assets/image-20230829151251014.png)

发现这有一个src

![image-20230829151309203](./极验四代.assets/image-20230829151309203.png)

这个src里面包含着w

![image-20230829151342504](./极验四代.assets/image-20230829151342504.png)

继续向上跟栈

![image-20230829151432944](./极验四代.assets/image-20230829151432944.png)

这里也是发现了src的信息

再向上跟栈，来到这里

![image-20230829151518789](./极验四代.assets/image-20230829151518789.png)

这里有点看不懂了

先不管了。

再继续向上翻。

![image-20230829151602333](./极验四代.assets/image-20230829151602333.png)

这里又发现了关于src的地址信息。

这里的a是参数传了进来，

在跟

![image-20230829151712388](./极验四代.assets/image-20230829151712388.png)

来到这里

![image-20230829151727719](./极验四代.assets/image-20230829151727719.png)

这个r就是a,把断点下到这里，看到上面有一个

![image-20230829161545225](./极验四代.assets/image-20230829161545225.png)

下断，

![image-20230829161621671](./极验四代.assets/image-20230829161621671.png)

发现我们要的w值就在这里

![image-20230829161717963](./极验四代.assets/image-20230829161717963.png)

断点打到入口位置继续跟a值

![image-20230829161755552](./极验四代.assets/image-20230829161755552.png)

这里发现有w可以继续跟了，

![image-20230829161821101](./极验四代.assets/image-20230829161821101.png)

继续向上

![image-20230829161856883](./极验四代.assets/image-20230829161856883.png)

到这里又出现了。

![image-20230829162005847](./极验四代.assets/image-20230829162005847.png)

这里的n包含了w，在上跟。	

![image-20230829162135360](./极验四代.assets/image-20230829162135360.png)

到这里发现了，i的生成过程。

![image-20230829162206371](./极验四代.assets/image-20230829162206371.png)

w也出现了。

                                    ~~~
                                    "\u0070\u0061\u0079\u006c\u006f\u0061\u0064\u005f\u0070\u0072\u006f\u0074\u006f\u0063\u006f\u006c": t[$_CBGHD(781)]  记录一下关键字方便搜索位置。
                                    ~~~

r就是我们参数的w值，

![image-20230829185008999](./极验四代.assets/image-20230829185008999.png)

来看一下这里，

这就是r的生成方式

![image-20230829185102323](./极验四代.assets/image-20230829185102323.png)

这里大概是这个套路

d[$_CBGHD(18)] 是生成加密的方法，需要两个参数 

第一个是 e参数将他json一下，

还有一个是s对象。

要搞定两个方法，两个参数

进去看这个加密函数

![image-20230905150738643](./极验四代.assets/image-20230905150738643.png)

这个r函数包含着我们所有的加密逻辑，

来分析一下吧

![image-20230905150829956](./极验四代.assets/image-20230905150829956.png)

先定位到他的返回值。

![image-20230905150854633](./极验四代.assets/image-20230905150854633.png)

这里就是我们要的w值

一步一步网上看

![image-20230905151209291](./极验四代.assets/image-20230905151209291.png)

要获取到u和c

先看u吧

![image-20230905151356079](./极验四代.assets/image-20230905151356079.png)

看一下u怎么来的

通过这个 i的第一个对象里面的symmertical里的encrypt 方法进行加密的

s是参数

再看看s怎么来的

![image-20230905151514665](./极验四代.assets/image-20230905151514665.png)

跟进去

![image-20230905151526446](./极验四代.assets/image-20230905151526446.png)



来自e在跟

![image-20230905151537869](./极验四代.assets/image-20230905151537869.png)

发现是随机的

还原一下吧

~~~js
get_s = function (){
    return (65536 * (1 + Math['random']()) | 0)['toString'](16)['substring'](1);

}
~~~

这样能得到s了

可以看加密函数了

![image-20230905152131754](./极验四代.assets/image-20230905152131754.png)

这里发现是一个非对称的加密，非对称第一反应就想到了rsa了

![image-20230905152240596](./极验四代.assets/image-20230905152240596.png)

这里扣这个加密方法，

但是这个函数涉及了很多的方法，这里扣代码一直要扣到这里

![image-20230905152359125](./极验四代.assets/image-20230905152359125.png)

从这个r一直到。

![image-20230905152437585](./极验四代.assets/image-20230905152437585.png)

他是将r导出了，所以我们要一个完整的r

![image-20230905152532203](./极验四代.assets/image-20230905152532203.png)

将所有混淆的都替换一下。

![image-20230905152600544](./极验四代.assets/image-20230905152600544.png)

最后补完就是这样。这里补完 我们的u就ok了

再看

![image-20230905152735479](./极验四代.assets/image-20230905152735479.png)

这个c

![image-20230905152858698](./极验四代.assets/image-20230905152858698.png)

进这里这个特征是不是很像一个aes加密

 参数是

![image-20230905153500934](./极验四代.assets/image-20230905153500934.png)

这个对象，加上 上面扣的s随机加密

在跟一点

再看这几个混淆的参数

![image-20230905153031154](./极验四代.assets/image-20230905153031154.png)

看到iv就可以确信了

![image-20230905153105701](./极验四代.assets/image-20230905153105701.png)

我们这里将他的代码还原

这样c就搞定了。

![image-20230905153144386](./极验四代.assets/image-20230905153144386.png)

这里的d[$_DGAIZ(132)])(c) 其实就是对c的

![image-20230905153237649](./极验四代.assets/image-20230905153237649.png)

进去直接扣下来
![image-20230905153255880](./极验四代.assets/image-20230905153255880.png)

还原一下

![image-20230905153311270](./极验四代.assets/image-20230905153311270.png)

这样w就拼出来了

## aes参数

![image-20230905154652450](./极验四代.assets/image-20230905154652450.png)

这里好好看一下这个aes的参数

他才是关键，整个逻辑没有轨迹setleft 这个才是移动的标识。

找到他们生成的位置。

![image-20230905154849242](./极验四代.assets/image-20230905154849242.png)

这里有 这几个值

![image-20230905154952625](./极验四代.assets/image-20230905154952625.png)

这里有这几个值

很容易就可以跟到

但是根据我测试

这里这个aes的第一个参数这个对象 只要setLeft和userresponse就可以通过的

最后我们连一起测试一下吧

![725007d38fdb06916e5533aff0451d6](./C:/Users/17766/AppData/Local/Temp/WeChat Files/725007d38fdb06916e5533aff0451d6.png)

![image-20230905155127424](./极验四代.assets/image-20230905155127424.png)

我测了100次，成功了96次

可以比人拉的准了。嘻嘻嘻嘻嘻

# 总结

因为这个 扣代码和根值的操作比较复杂，没办法一步一步的写文档，

只说一个思路和大概操作的方向，具体会有细节不足，抱歉。

最后要将3个接口连起来

下载图片 --->  识别缺口 ----> 验证

