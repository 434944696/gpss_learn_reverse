# 网易云音乐

> 网站地址： aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvZGlzY292ZXIvdG9wbGlzdA==
>
> https://github.com/Guapisansan/gpss_learn_reverse 代码在这里，会持续更新逆向案例

**免责声明： 此文档，以及脚本，仅用来对技术的学习与探讨，如有冒犯，请联系作者电话，微信13933566015进行删除**

## 寻找数据

逆向一下网易云音乐，先来到这个页面

![image-20230720102117775](./网易云音乐.assets/image-20230720102117775.png)

目标是可以将列表歌曲下载到本地即可。

刷新页面尝试进行抓包，进行关键字搜索，发现在toplist里面有关于 歌曲名称的信息。



![image-20230720102359441](./网易云音乐.assets/image-20230720102359441.png)

看一下响应中的位置吧，

![image-20230720102551264](./网易云音乐.assets/image-20230720102551264.png)

在id="song-list-pre-data"的标签中有一个数组。

将这个数组复制出来，在console里赋值打印，

![image-20230720102746882](./网易云音乐.assets/image-20230720102746882.png)

100首音乐歌单，但是并没有发现里面带有下载地址或者播放地址。

里面都是一些歌曲的信息，如歌曲名称，演唱歌手，发布时间，歌曲id等信息。

清空一下，网络请求，尝试进行播放音乐。

点击播放按钮，再次进行抓包

![image-20230720103139828](./网易云音乐.assets/image-20230720103139828.png)

可以直观看到这里有一个 后缀为m4a的文件。对这个格式了解的可以知道他是一个音频文件。

![image-20230720103239615](./网易云音乐.assets/image-20230720103239615.png)

所以这就是播放音乐的文件，复制连接到浏览器。

![image-20230720103312507](./网易云音乐.assets/image-20230720103312507.png)

找一下这个文件的生产位置，搜索一下文件后缀。

![image-20230720103509487](./网易云音乐.assets/image-20230720103509487.png)

发现在这个v1接口的响应中有关于url的信息，只要把这个v1接口搞通，大概率就可以拿到url，即可获取到音频文件

先查看v1接口的参数。

![image-20230720103745922](./网易云音乐.assets/image-20230720103745922.png)

这里发现params和encSecKey这两个参数都是加密的。

对其进行模拟请求，检验一下是否可以通过，

![image-20230720103952090](./网易云音乐.assets/image-20230720103952090.png)

发现去除headers和cookie也是可以直接访问成功的，所以只要解决了  **params**和**encSecKey** 就ok了。

开始进行逆向工作

## 逆向分析

对于这两个参数，先试着能不能搜索到，选择先搜索encSecKey 因为感觉params会很多

![image-20230720104548866](./网易云音乐.assets/image-20230720104548866.png)

这里直接就可以搜到，第二个位置就发现了，params和encSecKey在一起大概率就是了。

直接下一个断点

然后在尝试播放音乐，

![image-20230720104823246](./网易云音乐.assets/image-20230720104823246.png)

这个里的window.asrsea是一个加密函数，参数有4个，

同时 bsk5p也是一个加密函数，这里先试着扣出 bsk5p吧

### bsk5p

第一个先跟进去把函数复制出来用node跑一下

![image-20230720105042490](./网易云音乐.assets/image-20230720105042490.png)

将参数放进去，执行一下

![image-20230720105225874](./网易云音乐.assets/image-20230720105225874.png)

缺少**j5o**

![image-20230720105323324](./网易云音乐.assets/image-20230720105323324.png)

这里j5o是一个对象，对象里有好多方法，寻找一下j5o的生成位置吧

![image-20230720105446623](./网易云音乐.assets/image-20230720105446623.png)

这里有一个自执行函数，将j5o实例并注册多个方法。

我们将这个函数直接复制下来用node执行一下。

![image-20230720105647851](./网易云音乐.assets/image-20230720105647851.png)

已经不报j5o缺少了，而是新的 NEJ说明自执行函数生效了，再次寻找NEJ生成位置。

说一下寻找方法，在控制台打印NEJ,点进去这个函数往上翻，就可以找到生成位置了。

![image-20230720105817981](./网易云音乐.assets/image-20230720105817981.png)

还是一个自执行函数，将他复制执行，

![image-20230720110100224](./网易云音乐.assets/image-20230720110100224.png)

发现缺少window环境，补一下，

尝试用window = {}

![image-20230720110151039](./网易云音乐.assets/image-20230720110151039.png)

还是会报错的，尝试用window=global

![image-20230720110239075](./网易云音乐.assets/image-20230720110239075.png)

发现报错换成了location不存在，

location = {}

发现![image-20230720110335009](./网易云音乐.assets/image-20230720110335009.png)

说明他去寻找了这个空对象。

仔细看 location.href.split

他要去寻找location中的href  可是href等于什么呢

![image-20230720110509458](./网易云音乐.assets/image-20230720110509458.png)

到网页打印一下。将其复制过去再次执行吧。

![image-20230720110713330](./网易云音乐.assets/image-20230720110713330.png)

这次报了 document.createElement("a");  document不存在

![image-20230720111304059](./网易云音乐.assets/image-20230720111304059.png)

要啥就先给啥。

报错了 window.navigator.platform，window也需要一个对象，但是上面已经给了 global 

看一下这个东西是什么

![image-20230720111421914](./网易云音乐.assets/image-20230720111421914.png)

![image-20230720111525971](./网易云音乐.assets/image-20230720111525971.png)

找到报错位置直接写死了，顺手也把ua也加上了，再次执行

![image-20230720112514319](./网易云音乐.assets/image-20230720112514319.png)

还尼玛报j5o，可是咱们已经导入了啊，

这里猜测是因为作用域的问题，

将j5o导入到全局吧

![image-20230720112640286](./网易云音乐.assets/image-20230720112640286.png)

![image-20230720112706720](./网易云音乐.assets/image-20230720112706720.png)

导出完，将原来的j5o替换成window.j5o

![image-20230720112743172](./网易云音乐.assets/image-20230720112743172.png)

错误变成了  Vx0x is not defined

去网页看一下这是个什么东西

![image-20230720112821729](./网易云音乐.assets/image-20230720112821729.png)

是一个对象套的数组，直接可以拿过来

![image-20230720112957255](./网易云音乐.assets/image-20230720112957255.png)

成功了。多测试几个

![image-20230720113038741](./网易云音乐.assets/image-20230720113038741.png)

![image-20230720113114898](./网易云音乐.assets/image-20230720113114898.png)

和页面上的也一样，这个因该是没毛病了。

接下来看，window.asrsea

### window.asrsea

看一下是个什么方法。

![image-20230720113322391](./网易云音乐.assets/image-20230720113322391.png)

这里点进去是一个 d 方法，导出到window上了

将整个自执行函数都复制下来

并执行

![image-20230720114618816](./网易云音乐.assets/image-20230720114618816.png)

CryptoJS 不存在 直接导入报即可

~~~javascript
var CryptoJS = require('crypto-js')
~~~

导入再次执行

![image-20230720114755138](./网易云音乐.assets/image-20230720114755138.png)

还是去页面找到这个函数，拿下来

![image-20230720114858856](./网易云音乐.assets/image-20230720114858856.png)

这里其实补完了后面还有很多很多。多花点耐心还是可以补全的

![image-20230720115305667](./网易云音乐.assets/image-20230720115305667.png)

我这里一共补了这么多

常量和函数

![image-20230720115439555](./网易云音乐.assets/image-20230720115439555.png)

补完之后就可以加密成功了，然后我们可以带入到代码里测试一下

这里提示一点，这个加密取决于

![image-20230720115558571](./网易云音乐.assets/image-20230720115558571.png)

不同的接口i5n肯定也不一样要注意一下这个位置

![image-20230720115636848](./网易云音乐.assets/image-20230720115636848.png)

这里请求的地址，是不是我们要的v1，这个加密要经过好几个接口的

![image-20230720115735062](./网易云音乐.assets/image-20230720115735062.png)

才会到v1

![image-20230720115717496](./网易云音乐.assets/image-20230720115717496.png)

可以看到ids里面就是我们的歌曲的 id  2063567749

![image-20230720115838560](./网易云音乐.assets/image-20230720115838560.png)

用这个i5n 去加密得到的 加密参数再带入 请求。

![image-20230720115946745](./网易云音乐.assets/image-20230720115946745.png)

模拟请求

![image-20230720120050615](./网易云音乐.assets/image-20230720120050615.png)

可以得到正确的 返回值了。

这样一来我们的就大功告成了

有了歌曲列表，就可以下载了

## 总结

网易云加密主要是扣代码比较烦人

有点耐心就没问题的，还是比较容易的

毕竟没有混淆代码

**不要频繁访问他人网站，以免对其造成压力。**

![image-20230720133114243](./网易云音乐.assets/image-20230720133114243.png)